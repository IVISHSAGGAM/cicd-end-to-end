pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE_NAME = 'ivishsaggam/todo:v2    '  // Replace 'latest' with your desired tag
        GIT_REPO_NAME = "cicd-k8s-manifests"
        GIT_USER_NAME = "ivishsaggam"
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                git credentialsId: 'my-github-id', url: 'https://github.com/IVISHSAGGAM/cicd-end-to-end.git', branch: 'master'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                    echo 'Building Docker Image'
                    docker build -t $DOCKER_IMAGE_NAME .
                    """
                }
             }
          }
         stage('Push the artifacts'){
            steps{
                 script{
                     withCredentials([usernamePassword(credentialsId: 'my-dockerhub-id', passwordVariable: 'DOCKERHUB_PASSWORD', usernameVariable: 'DOCKERHUB_USERNAME')]) {
                         sh """
                         echo 'Pushing Docker Image to Docker Hub'
                         docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
                         docker push $DOCKER_IMAGE_NAME
                         docker logout
                         """
                }
            }
        }
   }
        
        stage('Checkout K8S manifest SCM') {
            steps {
                git credentialsId: 'my-github-id', url: "https://github.com/IVISHSAGGAM/cicd-k8s-manifests.git", branch: 'main'
            }
        }
        
        stage('Update K8S manifest & push to Repo') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'my-github-id', usernameVariable: 'GITHUB_USERNAME', passwordVariable: 'GITHUB_PASSWORD')]) {
                        sh """
                        cat k8s-manifests/deploy.yml
                        git config user.email "vishal.saggam72@gmail.com"
                        git config user.name "Vishal Saggam"
                        sed -i "s|ivishsaggam/todo:v2|$DOCKER_IMAGE_NAME|g" k8s-manifests/deploy.yml
                        cat k8s-manifests/deploy.yml
                        git add k8s-manifests/deploy.yml
                        git commit -m 'Updated the deploy yaml | Jenkins Pipeline'
                        git push https://${GITHUB_USERNAME}:${GITHUB_PASSWORD}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
                        """
                    }
                }
            }
        }
    }
}
